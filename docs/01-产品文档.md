# Veloera 产品文档

## 1. 产品概述

### 1.1 项目简介
Veloera 是一个基于 New API 二次开发的 **AI API 网关系统**，为企业和开发者提供统一的 AI 服务接入、管理、计费和监控解决方案。

### 1.2 核心价值
- **统一接入**：支持 30+ AI 服务商的统一 API 接口
- **智能调度**：多渠道负载均衡和故障转移
- **精确计费**：灵活的计费模式和配额管理
- **完整监控**：实时日志和数据分析
- **易于部署**：Docker 容器化部署，支持多种数据库

### 1.3 技术栈
- **后端**：Go 1.23.4 + Gin + GORM
- **前端**：React 19 + Next.js 15 + TypeScript + Tailwind CSS
- **数据库**：SQLite/MySQL/PostgreSQL
- **缓存**：Redis
- **部署**：Docker + Docker Compose

## 2. 功能特性

### 2.1 AI 模型中继服务

#### 支持的 AI 服务商
- **OpenAI**：GPT-3.5/4、DALL-E、Whisper、TTS
- **Anthropic**：Claude 系列模型
- **Google**：Gemini、PaLM
- **国内厂商**：百度文心、阿里通义千问、讯飞星火、腾讯混元、智谱 AI、DeepSeek
- **其他**：Cohere、Mistral、xAI、Perplexity、Ollama 等

#### API 接口类型
- 聊天完成：`/v1/chat/completions`
- 文本完成：`/v1/completions`
- 图像生成：`/v1/images/generations`
- 语音转文字：`/v1/audio/transcriptions`
- 文字转语音：`/v1/audio/speech`
- 文本嵌入：`/v1/embeddings`
- 重排序：`/v1/rerank`
- 实时对话：`/v1/realtime`

### 2.2 特色服务集成

#### Midjourney 图像生成
- 支持 Midjourney-Proxy 接口
- 图像生成、变换、混合功能
- 任务状态跟踪和管理

#### Suno 音乐生成
- AI 音乐创作服务
- 支持歌词生成和音乐制作

#### Claude Messages 格式
- 原生支持 Anthropic Claude 消息格式
- 完整的对话上下文管理

### 2.3 计费与配额管理

#### 灵活计费模式
- **按 Token 计费**：输入/输出 Token 分别计费
- **按次数计费**：模型调用次数计费
- **分组倍率**：不同用户组价格倍率
- **模型倍率**：每个模型独立价格设置
- **缓存计费**：缓存命中按比例计费

#### 在线充值系统
- 易支付集成，支持多种支付方式
- 充值码/礼品码系统
- 推荐返佣功能

### 2.4 用户管理系统

#### 多种认证方式
- 用户名/密码登录
- 第三方 OAuth：GitHub、LinuxDO、微信、Telegram、OIDC
- 邮箱验证注册

#### 权限管理
- 角色系统：游客、普通用户、管理员、超级管理员
- 用户分组管理
- 配额分配和使用统计

### 2.5 渠道管理

#### 智能调度
- 多 Key 随机选择
- 加权随机负载均衡
- 自动重试和故障转移
- 健康检测和自动禁用

#### 渠道配置
- 自定义 Base URL
- 模型映射和限制
- 响应时间监控

### 2.6 监控与日志

#### 详细日志系统
- 完整的 API 调用记录
- Token 使用统计
- 费用追踪
- 渠道使用情况

#### 数据看板
- 用户使用统计
- 收入分析
- 渠道性能监控

### 2.7 安全与限制

#### 访问控制
- API Token 管理
- IP 白名单限制
- 模型访问限制
- 速率限制

#### 内容安全
- 正则表达式敏感词过滤
- AI 服务商安全设置集成

## 3. 系统架构

### 3.1 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Web Frontend  │    │   Admin Panel   │    │   Mobile App    │
│   (React/Next)  │    │   (React/Next)  │    │   (Optional)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   API Gateway   │
                    │   (Gin Router)  │
                    └─────────────────┘
                                 │
         ┌───────────────────────┼───────────────────────┐
         │                       │                       │
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Relay Layer   │    │  Business Logic │    │   Auth Service  │
│   (AI Adaptors) │    │   (Controllers) │    │  (Middleware)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   Data Layer    │
                    │ (GORM + Cache)  │
                    └─────────────────┘
                                 │
         ┌───────────────────────┼───────────────────────┐
         │                       │                       │
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│    Database     │    │     Redis       │    │   File Storage  │
│ (MySQL/PgSQL/   │    │    (Cache)      │    │   (Optional)    │
│    SQLite)      │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 3.2 核心组件

#### API 网关层
- **路由管理**：统一的 API 路由和版本管理
- **认证授权**：Token 验证和权限控制
- **限流控制**：全局和用户级别的请求限制
- **日志记录**：完整的请求响应日志

#### 中继适配层
- **多厂商适配**：统一的 AI 服务商接口适配
- **协议转换**：不同 API 格式的标准化
- **负载均衡**：智能的渠道选择和调度
- **错误处理**：统一的错误处理和重试机制

#### 业务逻辑层
- **用户管理**：用户注册、登录、权限管理
- **渠道管理**：AI 服务商渠道的配置和监控
- **计费系统**：配额管理、使用统计、费用计算
- **任务管理**：异步任务的创建和状态跟踪

#### 数据存储层
- **关系数据库**：用户、渠道、日志等结构化数据
- **缓存系统**：高频访问数据的缓存
- **文件存储**：配置文件、日志文件等

## 4. 部署架构

### 4.1 单机部署
```
┌─────────────────────────────────────────────────────────────┐
│                        Docker Host                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │    Veloera      │  │      Redis      │  │     MySQL       │ │
│  │   Container     │  │   Container     │  │   Container     │ │
│  │   (Port 3000)   │  │   (Port 6379)   │  │   (Port 3306)   │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│           │                     │                     │        │
│           └─────────────────────┼─────────────────────┘        │
│                                 │                              │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Docker Network                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 多机部署
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Load Balancer │    │   Load Balancer │    │   Load Balancer │
│    (Nginx)      │    │    (Nginx)      │    │    (Nginx)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  Veloera Node1  │    │  Veloera Node2  │    │  Veloera Node3  │
│   (Master)      │    │   (Slave)       │    │   (Slave)       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
         ┌───────────────────────┼───────────────────────┐
         │                       │                       │
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Redis Cluster │    │  MySQL Cluster  │    │  File Storage   │
│   (Cache/Queue) │    │   (Database)    │    │   (Optional)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 5. 核心优势

### 5.1 相比原版 New API 的增强
- 单渠道多 Key 随机选取
- 礼品码系统支持
- 原生 HuggingFace `/hf/v1` 接口
- 正则表达式敏感词过滤
- 渠道 Key 前端显示（不加密）
- 日志刷新功能
- 空回复不计费
- 更丰富的 Token 统计

### 5.2 技术优势
- **高性能**：Go 语言高并发处理能力
- **高可用**：多节点部署和故障转移
- **易扩展**：模块化架构，易于添加新功能
- **易维护**：完整的日志和监控系统

### 5.3 商业优势
- **成本控制**：精确的使用统计和计费
- **用户体验**：统一的 API 接口和管理界面
- **运营支持**：完整的用户管理和数据分析
- **合规安全**：内容过滤和访问控制
