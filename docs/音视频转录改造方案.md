# Veloera éŸ³è§†é¢‘è½¬å½•æœåŠ¡æ”¹é€ æ–¹æ¡ˆ

## ğŸ¯ æ”¹é€ ç­–ç•¥æ¦‚è§ˆ

### æ ¸å¿ƒæ€è·¯
ä¿ç•™ Veloera çš„ï¼š
- âœ… ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ (users, tokens è¡¨)
- âœ… è®¡è´¹ä¸é…é¢ç³»ç»Ÿ (quota_data, topups è¡¨)
- âœ… æƒé™æ§åˆ¶ (roles, permissions)
- âœ… æ—¥å¿—ç›‘æ§ (logs è¡¨)
- âœ… Web ç®¡ç†ç•Œé¢

æ›¿æ¢ AI ä¸­è½¬åŠŸèƒ½ä¸ºï¼š
- ğŸ”„ éŸ³è§†é¢‘æ–‡ä»¶ä¸Šä¼ å¤„ç†
- ğŸ”„ å¤šç§è½¬å½•å¼•æ“é€‚é… (æ›¿æ¢ AI æœåŠ¡å•†é€‚é…å™¨)
- ğŸ”„ è½¬å½•ä»»åŠ¡ç®¡ç† (æ›¿æ¢ AI è¯·æ±‚ç®¡ç†)
- ğŸ”„ ç»“æœå­˜å‚¨ä¸ä¸‹è½½

## ğŸ“‹ è¯¦ç»†æ”¹é€ æ–¹æ¡ˆ

### 1. æ•°æ®åº“æ¨¡å‹è°ƒæ•´

#### 1.1 æ–°å¢è½¬å½•ç›¸å…³è¡¨

```sql
-- è½¬å½•ä»»åŠ¡è¡¨ (æ›¿æ¢åŸæ¥çš„ midjourney/task è¡¨)
CREATE TABLE transcription_tasks (
    id                  BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id             INT NOT NULL,                   -- ç”¨æˆ·ID
    token_id            INT,                            -- ä½¿ç”¨çš„Token ID
    channel_id          INT NOT NULL,                   -- è½¬å½•å¼•æ“æ¸ é“ID
    
    -- æ–‡ä»¶ä¿¡æ¯
    original_filename   VARCHAR(255) NOT NULL,          -- åŸå§‹æ–‡ä»¶å
    file_path           VARCHAR(512) NOT NULL,          -- æ–‡ä»¶å­˜å‚¨è·¯å¾„
    file_size           BIGINT NOT NULL,                -- æ–‡ä»¶å¤§å°(å­—èŠ‚)
    file_type           VARCHAR(50) NOT NULL,           -- æ–‡ä»¶ç±»å‹(mp3,mp4,wavç­‰)
    duration            INT,                            -- éŸ³è§†é¢‘æ—¶é•¿(ç§’)
    
    -- è½¬å½•é…ç½®
    language            VARCHAR(10) DEFAULT 'auto',     -- è¯­è¨€ä»£ç (zh,en,autoç­‰)
    model_name          VARCHAR(100),                   -- ä½¿ç”¨çš„æ¨¡å‹
    enable_timestamps   BOOLEAN DEFAULT TRUE,           -- æ˜¯å¦åŒ…å«æ—¶é—´æˆ³
    enable_speaker      BOOLEAN DEFAULT FALSE,          -- æ˜¯å¦è¯†åˆ«è¯´è¯äºº
    output_format       VARCHAR(20) DEFAULT 'json',     -- è¾“å‡ºæ ¼å¼(json,srt,txtç­‰)
    
    -- ä»»åŠ¡çŠ¶æ€
    status              VARCHAR(20) DEFAULT 'pending',  -- pending,processing,completed,failed
    progress            INT DEFAULT 0,                  -- è¿›åº¦ç™¾åˆ†æ¯”
    error_message       TEXT,                           -- é”™è¯¯ä¿¡æ¯
    
    -- ç»“æœä¿¡æ¯
    result_text         LONGTEXT,                       -- è½¬å½•æ–‡æœ¬ç»“æœ
    result_file_path    VARCHAR(512),                   -- ç»“æœæ–‡ä»¶è·¯å¾„
    confidence_score    DECIMAL(3,2),                   -- ç½®ä¿¡åº¦åˆ†æ•°
    
    -- è®¡è´¹ä¿¡æ¯
    quota_cost          INT DEFAULT 0,                  -- æ¶ˆè€—çš„é…é¢
    billing_duration    INT,                            -- è®¡è´¹æ—¶é•¿(ç§’)
    
    -- æ—¶é—´æˆ³
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    started_at          TIMESTAMP NULL,                 -- å¼€å§‹å¤„ç†æ—¶é—´
    completed_at        TIMESTAMP NULL,                 -- å®Œæˆæ—¶é—´
    updated_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_user_id (user_id),
    INDEX idx_token_id (token_id),
    INDEX idx_channel_id (channel_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
);

-- æ–‡ä»¶å­˜å‚¨è¡¨
CREATE TABLE file_storage (
    id              BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id         INT NOT NULL,
    task_id         BIGINT,                             -- å…³è”çš„è½¬å½•ä»»åŠ¡ID
    file_type       VARCHAR(20) NOT NULL,               -- original, result
    original_name   VARCHAR(255) NOT NULL,              -- åŸå§‹æ–‡ä»¶å
    stored_name     VARCHAR(255) NOT NULL,              -- å­˜å‚¨æ–‡ä»¶å
    file_path       VARCHAR(512) NOT NULL,              -- æ–‡ä»¶è·¯å¾„
    file_size       BIGINT NOT NULL,                    -- æ–‡ä»¶å¤§å°
    mime_type       VARCHAR(100),                       -- MIMEç±»å‹
    expires_at      TIMESTAMP NULL,                     -- è¿‡æœŸæ—¶é—´
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_user_id (user_id),
    INDEX idx_task_id (task_id),
    INDEX idx_file_type (file_type),
    INDEX idx_expires_at (expires_at)
);
```

#### 1.2 è°ƒæ•´ç°æœ‰è¡¨

```sql
-- è°ƒæ•´ channels è¡¨ï¼Œæ”¹ä¸ºè½¬å½•å¼•æ“é…ç½®
ALTER TABLE channels MODIFY COLUMN type INT COMMENT 'è½¬å½•å¼•æ“ç±»å‹: 1=é˜¿é‡Œäº‘, 2=è…¾è®¯äº‘, 3=ç™¾åº¦äº‘, 4=è®¯é£, 5=Azure, 6=AWS, 7=Google, 8=OpenAI Whisper';
ALTER TABLE channels MODIFY COLUMN models TEXT COMMENT 'æ”¯æŒçš„è¯­è¨€åˆ—è¡¨: zh,en,ja,koç­‰';
ALTER TABLE channels ADD COLUMN max_file_size BIGINT DEFAULT 104857600 COMMENT 'æœ€å¤§æ–‡ä»¶å¤§å°(å­—èŠ‚)';
ALTER TABLE channels ADD COLUMN supported_formats VARCHAR(255) DEFAULT 'mp3,mp4,wav,m4a,flac' COMMENT 'æ”¯æŒçš„æ–‡ä»¶æ ¼å¼';
ALTER TABLE channels ADD COLUMN max_duration INT DEFAULT 3600 COMMENT 'æœ€å¤§æ—¶é•¿(ç§’)';

-- è°ƒæ•´ logs è¡¨ï¼Œé€‚é…è½¬å½•æœåŠ¡
ALTER TABLE logs ADD COLUMN file_size BIGINT COMMENT 'å¤„ç†çš„æ–‡ä»¶å¤§å°';
ALTER TABLE logs ADD COLUMN duration INT COMMENT 'éŸ³è§†é¢‘æ—¶é•¿';
ALTER TABLE logs MODIFY COLUMN model_name VARCHAR(255) COMMENT 'è½¬å½•å¼•æ“/æ¨¡å‹åç§°';

-- è°ƒæ•´ quota_data è¡¨
ALTER TABLE quota_data ADD COLUMN file_count INT DEFAULT 0 COMMENT 'å¤„ç†æ–‡ä»¶æ•°é‡';
ALTER TABLE quota_data ADD COLUMN total_duration INT DEFAULT 0 COMMENT 'æ€»å¤„ç†æ—¶é•¿';
```

### 2. è½¬å½•å¼•æ“ç±»å‹å®šä¹‰

```go
// constant/transcription_engine.go
package constant

const (
    EngineTypeAliCloud    = 1  // é˜¿é‡Œäº‘è¯­éŸ³è¯†åˆ«
    EngineTypeTencent     = 2  // è…¾è®¯äº‘è¯­éŸ³è¯†åˆ«
    EngineTypeBaidu       = 3  // ç™¾åº¦è¯­éŸ³è¯†åˆ«
    EngineTypeXunfei      = 4  // è®¯é£è¯­éŸ³è¯†åˆ«
    EngineTypeAzure       = 5  // Azure Speech Services
    EngineTypeAWS         = 6  // AWS Transcribe
    EngineTypeGoogle      = 7  // Google Speech-to-Text
    EngineTypeWhisper     = 8  // OpenAI Whisper
    EngineTypeLocal       = 9  // æœ¬åœ°éƒ¨ç½²å¼•æ“
)

var EngineNames = map[int]string{
    EngineTypeAliCloud: "é˜¿é‡Œäº‘è¯­éŸ³è¯†åˆ«",
    EngineTypeTencent:  "è…¾è®¯äº‘è¯­éŸ³è¯†åˆ«",
    EngineTypeBaidu:    "ç™¾åº¦è¯­éŸ³è¯†åˆ«",
    EngineTypeXunfei:   "è®¯é£è¯­éŸ³è¯†åˆ«",
    EngineTypeAzure:    "Azure Speech Services",
    EngineTypeAWS:      "AWS Transcribe",
    EngineTypeGoogle:   "Google Speech-to-Text",
    EngineTypeWhisper:  "OpenAI Whisper",
    EngineTypeLocal:    "æœ¬åœ°éƒ¨ç½²å¼•æ“",
}

// æ”¯æŒçš„æ–‡ä»¶æ ¼å¼
var SupportedFormats = []string{
    "mp3", "mp4", "wav", "m4a", "flac", "aac", "ogg", "wma",
}

// æ”¯æŒçš„è¯­è¨€
var SupportedLanguages = map[string]string{
    "auto": "è‡ªåŠ¨æ£€æµ‹",
    "zh":   "ä¸­æ–‡",
    "en":   "è‹±è¯­",
    "ja":   "æ—¥è¯­",
    "ko":   "éŸ©è¯­",
    "es":   "è¥¿ç­ç‰™è¯­",
    "fr":   "æ³•è¯­",
    "de":   "å¾·è¯­",
    "ru":   "ä¿„è¯­",
}
```

### 3. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

#### 3.1 è½¬å½•ä»»åŠ¡æ¨¡å‹

```go
// model/transcription.go
package model

import (
    "time"
    "gorm.io/gorm"
)

type TranscriptionTask struct {
    ID                 int64     `json:"id" gorm:"primaryKey"`
    UserID             int       `json:"user_id" gorm:"not null;index"`
    TokenID            *int      `json:"token_id" gorm:"index"`
    ChannelID          int       `json:"channel_id" gorm:"not null;index"`
    
    // æ–‡ä»¶ä¿¡æ¯
    OriginalFilename   string    `json:"original_filename" gorm:"not null"`
    FilePath           string    `json:"file_path" gorm:"not null"`
    FileSize           int64     `json:"file_size" gorm:"not null"`
    FileType           string    `json:"file_type" gorm:"not null"`
    Duration           *int      `json:"duration"`
    
    // è½¬å½•é…ç½®
    Language           string    `json:"language" gorm:"default:'auto'"`
    ModelName          string    `json:"model_name"`
    EnableTimestamps   bool      `json:"enable_timestamps" gorm:"default:true"`
    EnableSpeaker      bool      `json:"enable_speaker" gorm:"default:false"`
    OutputFormat       string    `json:"output_format" gorm:"default:'json'"`
    
    // ä»»åŠ¡çŠ¶æ€
    Status             string    `json:"status" gorm:"default:'pending';index"`
    Progress           int       `json:"progress" gorm:"default:0"`
    ErrorMessage       string    `json:"error_message"`
    
    // ç»“æœä¿¡æ¯
    ResultText         string    `json:"result_text" gorm:"type:longtext"`
    ResultFilePath     string    `json:"result_file_path"`
    ConfidenceScore    *float64  `json:"confidence_score"`
    
    // è®¡è´¹ä¿¡æ¯
    QuotaCost          int       `json:"quota_cost" gorm:"default:0"`
    BillingDuration    *int      `json:"billing_duration"`
    
    // æ—¶é—´æˆ³
    CreatedAt          time.Time  `json:"created_at"`
    StartedAt          *time.Time `json:"started_at"`
    CompletedAt        *time.Time `json:"completed_at"`
    UpdatedAt          time.Time  `json:"updated_at"`
}

// ä»»åŠ¡çŠ¶æ€å¸¸é‡
const (
    TaskStatusPending    = "pending"
    TaskStatusProcessing = "processing"
    TaskStatusCompleted  = "completed"
    TaskStatusFailed     = "failed"
)

// è¾“å‡ºæ ¼å¼å¸¸é‡
const (
    OutputFormatJSON = "json"
    OutputFormatSRT  = "srt"
    OutputFormatTXT  = "txt"
    OutputFormatVTT  = "vtt"
)
```

#### 3.2 è½¬å½•å¼•æ“é€‚é…å™¨æ¥å£

```go
// service/transcription/adaptor.go
package transcription

import (
    "context"
    "io"
    "veloera/model"
)

// TranscriptionAdaptor è½¬å½•å¼•æ“é€‚é…å™¨æ¥å£
type TranscriptionAdaptor interface {
    // è·å–å¼•æ“åç§°
    GetEngineName() string
    
    // è·å–æ”¯æŒçš„æ–‡ä»¶æ ¼å¼
    GetSupportedFormats() []string
    
    // è·å–æ”¯æŒçš„è¯­è¨€
    GetSupportedLanguages() []string
    
    // è·å–æœ€å¤§æ–‡ä»¶å¤§å°é™åˆ¶
    GetMaxFileSize() int64
    
    // è·å–æœ€å¤§æ—¶é•¿é™åˆ¶
    GetMaxDuration() int
    
    // éªŒè¯æ–‡ä»¶æ˜¯å¦ç¬¦åˆè¦æ±‚
    ValidateFile(filePath string, fileSize int64, duration int) error
    
    // æäº¤è½¬å½•ä»»åŠ¡
    SubmitTask(ctx context.Context, task *model.TranscriptionTask, fileReader io.Reader) error
    
    // æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
    QueryTaskStatus(ctx context.Context, task *model.TranscriptionTask) error
    
    // è·å–è½¬å½•ç»“æœ
    GetResult(ctx context.Context, task *model.TranscriptionTask) (*TranscriptionResult, error)
    
    // å–æ¶ˆä»»åŠ¡
    CancelTask(ctx context.Context, task *model.TranscriptionTask) error
}

// TranscriptionResult è½¬å½•ç»“æœ
type TranscriptionResult struct {
    Text            string                 `json:"text"`
    Segments        []TranscriptionSegment `json:"segments,omitempty"`
    Language        string                 `json:"language"`
    Duration        float64                `json:"duration"`
    ConfidenceScore float64                `json:"confidence_score"`
}

// TranscriptionSegment è½¬å½•ç‰‡æ®µ
type TranscriptionSegment struct {
    ID              int     `json:"id"`
    Start           float64 `json:"start"`
    End             float64 `json:"end"`
    Text            string  `json:"text"`
    Speaker         string  `json:"speaker,omitempty"`
    Confidence      float64 `json:"confidence"`
}
```
