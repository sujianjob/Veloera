# Veloera 音视频转录服务改造方案

## 🎯 改造策略概览

### 核心思路
保留 Veloera 的：
- ✅ 用户管理系统 (users, tokens 表)
- ✅ 计费与配额系统 (quota_data, topups 表)
- ✅ 权限控制 (roles, permissions)
- ✅ 日志监控 (logs 表)
- ✅ Web 管理界面

替换 AI 中转功能为：
- 🔄 音视频文件上传处理
- 🔄 多种转录引擎适配 (替换 AI 服务商适配器)
- 🔄 转录任务管理 (替换 AI 请求管理)
- 🔄 结果存储与下载

## 📋 详细改造方案

### 1. 数据库模型调整

#### 1.1 新增转录相关表

```sql
-- 转录任务表 (替换原来的 midjourney/task 表)
CREATE TABLE transcription_tasks (
    id                  BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id             INT NOT NULL,                   -- 用户ID
    token_id            INT,                            -- 使用的Token ID
    channel_id          INT NOT NULL,                   -- 转录引擎渠道ID
    
    -- 文件信息
    original_filename   VARCHAR(255) NOT NULL,          -- 原始文件名
    file_path           VARCHAR(512) NOT NULL,          -- 文件存储路径
    file_size           BIGINT NOT NULL,                -- 文件大小(字节)
    file_type           VARCHAR(50) NOT NULL,           -- 文件类型(mp3,mp4,wav等)
    duration            INT,                            -- 音视频时长(秒)
    
    -- 转录配置
    language            VARCHAR(10) DEFAULT 'auto',     -- 语言代码(zh,en,auto等)
    model_name          VARCHAR(100),                   -- 使用的模型
    enable_timestamps   BOOLEAN DEFAULT TRUE,           -- 是否包含时间戳
    enable_speaker      BOOLEAN DEFAULT FALSE,          -- 是否识别说话人
    output_format       VARCHAR(20) DEFAULT 'json',     -- 输出格式(json,srt,txt等)
    
    -- 任务状态
    status              VARCHAR(20) DEFAULT 'pending',  -- pending,processing,completed,failed
    progress            INT DEFAULT 0,                  -- 进度百分比
    error_message       TEXT,                           -- 错误信息
    
    -- 结果信息
    result_text         LONGTEXT,                       -- 转录文本结果
    result_file_path    VARCHAR(512),                   -- 结果文件路径
    confidence_score    DECIMAL(3,2),                   -- 置信度分数
    
    -- 计费信息
    quota_cost          INT DEFAULT 0,                  -- 消耗的配额
    billing_duration    INT,                            -- 计费时长(秒)
    
    -- 时间戳
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    started_at          TIMESTAMP NULL,                 -- 开始处理时间
    completed_at        TIMESTAMP NULL,                 -- 完成时间
    updated_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_user_id (user_id),
    INDEX idx_token_id (token_id),
    INDEX idx_channel_id (channel_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
);

-- 文件存储表
CREATE TABLE file_storage (
    id              BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id         INT NOT NULL,
    task_id         BIGINT,                             -- 关联的转录任务ID
    file_type       VARCHAR(20) NOT NULL,               -- original, result
    original_name   VARCHAR(255) NOT NULL,              -- 原始文件名
    stored_name     VARCHAR(255) NOT NULL,              -- 存储文件名
    file_path       VARCHAR(512) NOT NULL,              -- 文件路径
    file_size       BIGINT NOT NULL,                    -- 文件大小
    mime_type       VARCHAR(100),                       -- MIME类型
    expires_at      TIMESTAMP NULL,                     -- 过期时间
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_user_id (user_id),
    INDEX idx_task_id (task_id),
    INDEX idx_file_type (file_type),
    INDEX idx_expires_at (expires_at)
);
```

#### 1.2 调整现有表

```sql
-- 调整 channels 表，改为转录引擎配置
ALTER TABLE channels MODIFY COLUMN type INT COMMENT '转录引擎类型: 1=阿里云, 2=腾讯云, 3=百度云, 4=讯飞, 5=Azure, 6=AWS, 7=Google, 8=OpenAI Whisper';
ALTER TABLE channels MODIFY COLUMN models TEXT COMMENT '支持的语言列表: zh,en,ja,ko等';
ALTER TABLE channels ADD COLUMN max_file_size BIGINT DEFAULT 104857600 COMMENT '最大文件大小(字节)';
ALTER TABLE channels ADD COLUMN supported_formats VARCHAR(255) DEFAULT 'mp3,mp4,wav,m4a,flac' COMMENT '支持的文件格式';
ALTER TABLE channels ADD COLUMN max_duration INT DEFAULT 3600 COMMENT '最大时长(秒)';

-- 调整 logs 表，适配转录服务
ALTER TABLE logs ADD COLUMN file_size BIGINT COMMENT '处理的文件大小';
ALTER TABLE logs ADD COLUMN duration INT COMMENT '音视频时长';
ALTER TABLE logs MODIFY COLUMN model_name VARCHAR(255) COMMENT '转录引擎/模型名称';

-- 调整 quota_data 表
ALTER TABLE quota_data ADD COLUMN file_count INT DEFAULT 0 COMMENT '处理文件数量';
ALTER TABLE quota_data ADD COLUMN total_duration INT DEFAULT 0 COMMENT '总处理时长';
```

### 2. 转录引擎类型定义

```go
// constant/transcription_engine.go
package constant

const (
    EngineTypeAliCloud    = 1  // 阿里云语音识别
    EngineTypeTencent     = 2  // 腾讯云语音识别
    EngineTypeBaidu       = 3  // 百度语音识别
    EngineTypeXunfei      = 4  // 讯飞语音识别
    EngineTypeAzure       = 5  // Azure Speech Services
    EngineTypeAWS         = 6  // AWS Transcribe
    EngineTypeGoogle      = 7  // Google Speech-to-Text
    EngineTypeWhisper     = 8  // OpenAI Whisper
    EngineTypeLocal       = 9  // 本地部署引擎
)

var EngineNames = map[int]string{
    EngineTypeAliCloud: "阿里云语音识别",
    EngineTypeTencent:  "腾讯云语音识别",
    EngineTypeBaidu:    "百度语音识别",
    EngineTypeXunfei:   "讯飞语音识别",
    EngineTypeAzure:    "Azure Speech Services",
    EngineTypeAWS:      "AWS Transcribe",
    EngineTypeGoogle:   "Google Speech-to-Text",
    EngineTypeWhisper:  "OpenAI Whisper",
    EngineTypeLocal:    "本地部署引擎",
}

// 支持的文件格式
var SupportedFormats = []string{
    "mp3", "mp4", "wav", "m4a", "flac", "aac", "ogg", "wma",
}

// 支持的语言
var SupportedLanguages = map[string]string{
    "auto": "自动检测",
    "zh":   "中文",
    "en":   "英语",
    "ja":   "日语",
    "ko":   "韩语",
    "es":   "西班牙语",
    "fr":   "法语",
    "de":   "德语",
    "ru":   "俄语",
}
```

### 3. 核心业务逻辑

#### 3.1 转录任务模型

```go
// model/transcription.go
package model

import (
    "time"
    "gorm.io/gorm"
)

type TranscriptionTask struct {
    ID                 int64     `json:"id" gorm:"primaryKey"`
    UserID             int       `json:"user_id" gorm:"not null;index"`
    TokenID            *int      `json:"token_id" gorm:"index"`
    ChannelID          int       `json:"channel_id" gorm:"not null;index"`
    
    // 文件信息
    OriginalFilename   string    `json:"original_filename" gorm:"not null"`
    FilePath           string    `json:"file_path" gorm:"not null"`
    FileSize           int64     `json:"file_size" gorm:"not null"`
    FileType           string    `json:"file_type" gorm:"not null"`
    Duration           *int      `json:"duration"`
    
    // 转录配置
    Language           string    `json:"language" gorm:"default:'auto'"`
    ModelName          string    `json:"model_name"`
    EnableTimestamps   bool      `json:"enable_timestamps" gorm:"default:true"`
    EnableSpeaker      bool      `json:"enable_speaker" gorm:"default:false"`
    OutputFormat       string    `json:"output_format" gorm:"default:'json'"`
    
    // 任务状态
    Status             string    `json:"status" gorm:"default:'pending';index"`
    Progress           int       `json:"progress" gorm:"default:0"`
    ErrorMessage       string    `json:"error_message"`
    
    // 结果信息
    ResultText         string    `json:"result_text" gorm:"type:longtext"`
    ResultFilePath     string    `json:"result_file_path"`
    ConfidenceScore    *float64  `json:"confidence_score"`
    
    // 计费信息
    QuotaCost          int       `json:"quota_cost" gorm:"default:0"`
    BillingDuration    *int      `json:"billing_duration"`
    
    // 时间戳
    CreatedAt          time.Time  `json:"created_at"`
    StartedAt          *time.Time `json:"started_at"`
    CompletedAt        *time.Time `json:"completed_at"`
    UpdatedAt          time.Time  `json:"updated_at"`
}

// 任务状态常量
const (
    TaskStatusPending    = "pending"
    TaskStatusProcessing = "processing"
    TaskStatusCompleted  = "completed"
    TaskStatusFailed     = "failed"
)

// 输出格式常量
const (
    OutputFormatJSON = "json"
    OutputFormatSRT  = "srt"
    OutputFormatTXT  = "txt"
    OutputFormatVTT  = "vtt"
)
```

#### 3.2 转录引擎适配器接口

```go
// service/transcription/adaptor.go
package transcription

import (
    "context"
    "io"
    "veloera/model"
)

// TranscriptionAdaptor 转录引擎适配器接口
type TranscriptionAdaptor interface {
    // 获取引擎名称
    GetEngineName() string
    
    // 获取支持的文件格式
    GetSupportedFormats() []string
    
    // 获取支持的语言
    GetSupportedLanguages() []string
    
    // 获取最大文件大小限制
    GetMaxFileSize() int64
    
    // 获取最大时长限制
    GetMaxDuration() int
    
    // 验证文件是否符合要求
    ValidateFile(filePath string, fileSize int64, duration int) error
    
    // 提交转录任务
    SubmitTask(ctx context.Context, task *model.TranscriptionTask, fileReader io.Reader) error
    
    // 查询任务状态
    QueryTaskStatus(ctx context.Context, task *model.TranscriptionTask) error
    
    // 获取转录结果
    GetResult(ctx context.Context, task *model.TranscriptionTask) (*TranscriptionResult, error)
    
    // 取消任务
    CancelTask(ctx context.Context, task *model.TranscriptionTask) error
}

// TranscriptionResult 转录结果
type TranscriptionResult struct {
    Text            string                 `json:"text"`
    Segments        []TranscriptionSegment `json:"segments,omitempty"`
    Language        string                 `json:"language"`
    Duration        float64                `json:"duration"`
    ConfidenceScore float64                `json:"confidence_score"`
}

// TranscriptionSegment 转录片段
type TranscriptionSegment struct {
    ID              int     `json:"id"`
    Start           float64 `json:"start"`
    End             float64 `json:"end"`
    Text            string  `json:"text"`
    Speaker         string  `json:"speaker,omitempty"`
    Confidence      float64 `json:"confidence"`
}
```
