#!/bin/bash

# æµ‹è¯•ç¼–è¯‘è„šæœ¬ - æ£€æŸ¥æ‰€æœ‰ç¼–è¯‘é”™è¯¯æ˜¯å¦å·²ä¿®å¤
echo "ðŸ”§ å¼€å§‹æµ‹è¯•ç¼–è¯‘..."

# è®¾ç½® Go çŽ¯å¢ƒ
export GO111MODULE=on
export GOPROXY=https://goproxy.cn,direct

# æ¸…ç†ç¼“å­˜
echo "ðŸ§¹ æ¸…ç† Go æ¨¡å—ç¼“å­˜..."
go clean -modcache

# ä¸‹è½½ä¾èµ–
echo "ðŸ“¦ ä¸‹è½½ä¾èµ–..."
go mod tidy

# æ£€æŸ¥è¯­æ³•é”™è¯¯
echo "ðŸ” æ£€æŸ¥è¯­æ³•é”™è¯¯..."
go vet ./...
if [ $? -ne 0 ]; then
    echo "âŒ è¯­æ³•æ£€æŸ¥å¤±è´¥ï¼"
    exit 1
fi

# å°è¯•ç¼–è¯‘
echo "ðŸ”¨ å¼€å§‹ç¼–è¯‘..."
go build -v -o veloera_test

if [ $? -eq 0 ]; then
    echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
    
    # æ¸…ç†æµ‹è¯•æ–‡ä»¶
    rm -f veloera_test
    
    echo ""
    echo "ðŸŽ‰ æ‰€æœ‰ç¼–è¯‘é”™è¯¯å·²ä¿®å¤ï¼"
    echo ""
    echo "ðŸ“‹ ä¿®å¤çš„ä¸»è¦é—®é¢˜ï¼š"
    echo "â€¢ ä¿®å¤äº† BaseAdaptor ç¼ºå¤±çš„æ–¹æ³•å®žçŽ°"
    echo "â€¢ æ·»åŠ äº†ç¼ºå¤±çš„ time åŒ…å¯¼å…¥"
    echo "â€¢ ä¿®å¤äº†å­—æ®µç±»åž‹ä¸åŒ¹é…é—®é¢˜"
    echo "â€¢ ä¿®å¤äº†å‡½æ•°è°ƒç”¨å‚æ•°ä¸åŒ¹é…"
    echo "â€¢ æ·»åŠ äº†ç¼ºå¤±çš„æ•°æ®åº“æ–¹æ³•"
    echo ""
    echo "ðŸš€ çŽ°åœ¨å¯ä»¥è¿›è¡Œéƒ¨ç½²æµ‹è¯•äº†ï¼"
    
else
    echo "âŒ ç¼–è¯‘å¤±è´¥ï¼è¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯ï¼š"
    echo ""
    go build -v -o veloera_test 2>&1
    exit 1
fi
